name: workflow-status

on:
  workflow_dispatch:
    inputs:
      location:
        description: 'location'
        required: true
        default: 'southcentralus'
      resourcegroup:
        description: 'resourcegroup'
        required: true
        default: 'default-rg'

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Run Terraform
        run: |
          terraform plan
  notification:
    name: Notify
    runs-on: ubuntu-latest
    needs: [build]
    if: always()
    steps:
      - name: Dump GitHub context
        env:
          GITHUB_CONTEXT: ${{ toJson(github) }}
        run: echo "$GITHUB_CONTEXT"
      - name: Dump job context
        env:
          JOB_CONTEXT: ${{ toJson(job) }}
        run: echo "$JOB_CONTEXT"
      - name: Dump steps context
        env:
          STEPS_CONTEXT: ${{ toJson(steps) }}
        run: echo "$STEPS_CONTEXT"
      - name: Dump runner context
        env:
          RUNNER_CONTEXT: ${{ toJson(runner) }}
        run: echo "$RUNNER_CONTEXT"
      - name: Dump strategy context
        env:
          STRATEGY_CONTEXT: ${{ toJson(strategy) }}
        run: echo "$STRATEGY_CONTEXT"
      - name: Dump matrix context
        env:
          MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      - uses: martialonline/workflow-status@v3
        id: check
      - run: echo "Workflow was cancelled"
        if: steps.check.outputs.status == 'cancelled'
      - run: echo "Workflow was successful"
        if: steps.check.outputs.status == 'success'
      - name: Send API call on failure
        if: steps.check.outputs.status == 'failure'
        run: |
          echo "Calling API with URL: ${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}"
          curl -X POST http://localhost:8080/api \
          -H "Content-Type: application/json" \
          -d "{\"url\": \"${{ github.event.repository.html_url }}/actions/runs/${{ github.run_id }}\"}"
